---
# library :: clone-repositories

  - name: "Cloning repositories from {{ box_cache_path }}"
    when: (lookup('dict', item).value.clone is defined)
    git:
      repo: "{{ _cache_path }}"
      dest: "{{ _clone_path }}"
      remote: origin
      clone: yes
      update: no
    vars:
      _upstream: "{{ lookup('dict', item).value.upstream }}"
      _host: "{{ _upstream | urlsplit('hostname') }}"
      _path: "{{ _upstream | urlsplit('path') }}"
      _cache_path: "{{ box_cache_path }}/{{ _host }}{{ _path }}"
      _clone_path: "{{ lookup('dict', item).value.clone }}"
    loop: "{{ a_repository_list }}"

  - name: Adding upstream remote
    when: (lookup('dict', item).value.clone is defined)
    command: "git remote add upstream {{ _upstream }}"
    args:
      chdir: "{{ lookup('dict', item).value.clone }}"
    vars:
      _upstream: "{{ lookup('dict', item).value.upstream }}"
    ignore_errors: true
    loop: "{{ a_repository_list }}"

  - name: Initializing repositories
    when:
      - lookup('dict', item).value.clone is defined
      - lookup('dict', item).value.setup is defined
    command: "{{ lookup('dict', item).value.setup }}"
    args:
      chdir: "{{ lookup('dict', item).value.clone }}"
    loop: "{{ a_repository_list }}"
