#
# Bootstrap
#

!config:'# ==== BOOTSTRAP ===='
!config:'L=/lib:/lib64:/usr/lib:/usr/lib64'
!config:'export LD_LIBRARY_PATH="$L:${WORKSPACE_BOOTSTRAP}/usr/lib:${WORKSPACE_BOOTSTRAP}/usr/lib64"'
!config:'export PATH="${WORKSPACE_BOOTSTRAP}/usr/bin:${PATH}"'

if_system:"CentOS"
   if_sudo:
      warn:"Running as Sudo"
      write_file:"/etc/yum.repos.d/CentOS-Bootstrap.repo"
         !puts:"[mirror-bootstrap]"
         !puts:"name=CentOS-$releasever - Bootstrap Mirror"
         !puts:"baseurl=http://localhost:8080/system/centos/$releasever/os/$basearch/"
         !puts:"gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7"
         !puts:"gpgcheck=1"
         !puts:"enabled=1"
         !puts:""
      end_write_file

      setup:'yum install -y --disablerepo=* --enablerepo=mirror-bootstrap git'
      setup:'yum install -y --disablerepo=* --enablerepo=mirror-bootstrap curl'
      setup:'yum install -y --disablerepo=* --enablerepo=mirror-bootstrap rsync'
      setup:'yum install -y --disablerepo=* --enablerepo=mirror-bootstrap python3'

      unless:ansible
         warn:"Run bootstrap as user to install ansible"
      end_unless

   else_sudo
      unless:git
         yum_stage:git
      end_unless
      unless:curl
         yum_stage:curl
      end_unless
      unless:rsync
         yum_stage:rsync
      end_unless
      unless:python3
         yum_stage:python3
      end_unless

      yum_bootstrap

      unless:ansible
         setup:"python3 -m pip install --user --trusted-host localhost --no-index --find-links='http://localhost:8080/pypi/' ansible"
      end_unless
   end_if_sudo
end_if_system
